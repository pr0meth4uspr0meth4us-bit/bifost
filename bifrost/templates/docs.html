<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bifrost Developer Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth; }
        .prose code { color: #ec4899; font-weight: 600; font-size: 0.9em; background: #fdf2f8; padding: 2px 4px; rounded: 4px; }
        .prose pre { background: #1e293b; padding: 1.5rem; overflow-x: auto; color: white; margin-bottom: 1.5rem; border-radius: 0.75rem; }
        .prose pre code { background: transparent; color: inherit; padding: 0; font-weight: 400; }
        .sidebar-link.active { background-color: #e0e7ff; color: #4338ca; border-right: 3px solid #4338ca; }
        h1, h2, h3, h4 { scroll-margin-top: 6rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

<div class="flex h-screen overflow-hidden">
    <aside class="w-72 bg-white border-r border-slate-200 flex-shrink-0 hidden md:flex flex-col overflow-y-auto z-10">
        <div class="p-6 border-b border-slate-100 sticky top-0 bg-white">
            <h1 class="text-xl font-extrabold text-slate-900 tracking-tight">Bifrost <span class="text-indigo-600">Docs</span></h1>
            <p class="text-xs text-slate-400 mt-1 font-bold uppercase">Developer Platform v0.4.3</p>
        </div>
        <nav class="p-4 space-y-8">
            <div>
                <h5 class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Getting Started</h5>
                <div class="space-y-1">
                    <a href="#intro" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Introduction</a>
                    <a href="#roles" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">User Roles</a>
                </div>
            </div>

            <div>
                <h5 class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Client Authentication</h5>
                <div class="space-y-1">
                    <a href="#auth-login" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Login</a>
                    <a href="#auth-register" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Registration Flow</a>
                    <a href="#auth-telegram" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Telegram Login</a>
                </div>
            </div>

            <div>
                <h5 class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Internal API (S2S)</h5>
                <div class="space-y-1">
                    <a href="#internal-validate" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Validate Token</a>
                    <a href="#internal-linking" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Account Linking</a>
                    <a href="#internal-user" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">User Info</a>
                </div>
            </div>

            <div>
                <h5 class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Payments</h5>
                <div class="space-y-1">
                    <a href="#payments-intent" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Secure Intent</a>
                    <a href="#payments-proof" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Submit Proof</a>
                </div>
            </div>

            <div>
                <h5 class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Events</h5>
                <div class="space-y-1">
                    <a href="#webhooks-security" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Security & Verification</a>
                    <a href="#webhooks-types" class="sidebar-link block px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-lg">Event Types</a>
                </div>
            </div>
        </nav>
        <div class="mt-auto p-6 border-t border-slate-100 bg-white">
            <a href="/" class="text-xs font-bold text-slate-400 hover:text-indigo-600">‚Üê Back to Portal</a>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-slate-50 scroll-smooth">
        <div class="max-w-4xl mx-auto px-8 py-12 prose prose-slate max-w-none">

            <section id="intro" class="mb-16">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-6">Bifrost Integration Guide</h1>
                <p class="text-lg leading-relaxed mb-4">
                    Bifrost is the centralized Identity Provider (IdP) and Payment Gateway for the Helm ecosystem.
                    It handles user authentication, session management via JWT, and subscription payments so you can focus on building your app logic.
                </p>
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex items-start space-x-3 mb-6">
                    <span class="text-2xl">üîë</span>
                    <div>
                        <h4 class="font-bold text-indigo-900 text-sm uppercase mb-1">Prerequisites</h4>
                        <p class="text-sm text-indigo-800">
                            You need a <strong>Client ID</strong> and <strong>Client Secret</strong>.
                            Obtain these from the <a href="/backoffice" class="underline">Bifrost Backoffice</a>.
                        </p>
                    </div>
                </div>
            </section>

            <section id="roles" class="mb-16">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">User Roles</h2>
                <p>Bifrost assigns roles per application link. A user can be an Admin in App A but a Guest in App B.</p>
                <ul class="list-disc pl-5 space-y-2">
                    <li><code>guest</code>: Default for new users. Limited access.</li>
                    <li><code>user</code>: Verified standard user (free tier).</li>
                    <li><code>premium_user</code>: Paid subscriber. Unlocks features.</li>
                    <li><code>admin</code>: Application administrator.</li>
                </ul>
            </section>

            <hr class="border-slate-200 my-10">

            <section id="auth-login" class="mb-16">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">1. Client Authentication</h2>
                <p class="mb-6">Public endpoints for your frontend client (React, Vue, Mobile, etc.). No Client Secret required.</p>

                <h3 class="text-lg font-bold text-slate-800 mb-2">Login</h3>
                <div class="flex items-center space-x-2 mb-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                    <code class="text-slate-600 text-sm">/auth/api/login</code>
                </div>
                <pre><code class="language-bash">curl -X POST https://bifrost.helm.com/auth/api/login \
-H "Content-Type: application/json" \
-d '{
    "client_id": "YOUR_CLIENT_ID",
    "identifier": "user@example.com", // OR username
    "password": "user_password"
}'</code></pre>
                <h4 class="font-bold text-slate-800 mb-2">Response (200 OK)</h4>
                <pre><code class="language-json">{
    "jwt": "eyJhbGciOiJIUzI1NiIs...",
    "account_id": "65a1b2c3d4...",
    "username": "johndoe",
    "display_name": "John Doe"
}</code></pre>
            </section>

            <section id="auth-register" class="mb-16">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Headless Registration Flow</h3>
                <p class="mb-4">Registration requires email verification. Follow this 3-step process:</p>

                <div class="border-l-4 border-slate-300 pl-4 ml-2 space-y-8">
                    <div>
                        <h4 class="font-bold text-slate-900">Step 1: Request OTP</h4>
                        <div class="flex items-center space-x-2 mb-2 mt-2">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                            <code class="text-slate-600 text-sm">/auth/api/request-email-otp</code>
                        </div>
                        <pre><code class="language-json">{
    "email": "newuser@example.com",
    "client_id": "YOUR_CLIENT_ID"
}</code></pre>
                        <p class="text-sm">Response includes a <code>verification_id</code>. Save this.</p>
                    </div>

                    <div>
                        <h4 class="font-bold text-slate-900">Step 2: Verify OTP</h4>
                        <div class="flex items-center space-x-2 mb-2 mt-2">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                            <code class="text-slate-600 text-sm">/auth/api/verify-email-otp</code>
                        </div>
                        <pre><code class="language-json">{
    "verification_id": "PREVIOUS_RESPONSE_ID",
    "code": "123456"
}</code></pre>
                        <p class="text-sm">Response includes a <code>proof_token</code> (JWT). This proves the email is verified.</p>
                    </div>

                    <div>
                        <h4 class="font-bold text-slate-900">Step 3: Complete Registration</h4>
                        <div class="flex items-center space-x-2 mb-2 mt-2">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                            <code class="text-slate-600 text-sm">/auth/api/complete-registration</code>
                        </div>
                        <pre><code class="language-json">{
    "proof_token": "JWT_FROM_STEP_2",
    "client_id": "YOUR_CLIENT_ID",
    "password": "securePassword123",
    "display_name": "John Doe",
    "username": "johndoe" // Optional
}</code></pre>
                        <p class="text-sm">Returns the final User JWT and Account ID.</p>
                    </div>
                </div>
            </section>

            <section id="auth-telegram" class="mb-16">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Telegram Widget Login</h3>
                <p class="mb-4">Authenticate via the Telegram Login Widget data.</p>
                <div class="flex items-center space-x-2 mb-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                    <code class="text-slate-600 text-sm">/auth/api/telegram-login</code>
                </div>
                <pre><code class="language-json">{
    "client_id": "YOUR_CLIENT_ID",
    "telegram_data": {
        "id": 123456789,
        "first_name": "John",
        "auth_date": 1700000000,
        "hash": "..."
    }
}</code></pre>
            </section>

            <hr class="border-slate-200 my-10">

            <section id="internal-validate" class="mb-16">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">2. Internal API (Server-to-Server)</h2>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6">
                    <p class="text-amber-700 text-sm font-bold">üîí Security Note: All endpoints here require Basic Auth using your Client ID (username) and Client Secret (password).</p>
                </div>

                <h3 class="text-lg font-bold text-slate-800 mb-2">Validate Token</h3>
                <p class="mb-2">Verify a User JWT sent from your frontend.</p>
                <div class="flex items-center space-x-2 mb-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                    <code class="text-slate-600 text-sm">/internal/validate-token</code>
                </div>
                <pre><code class="language-bash">curl -X POST https://bifrost.helm.com/internal/validate-token \
-u "CLIENT_ID:CLIENT_SECRET" \
-H "Content-Type: application/json" \
-d '{ "jwt": "USER_JWT" }'</code></pre>

                <h4 class="font-bold text-slate-800 mb-2">Response</h4>
                <pre><code class="language-json">{
    "is_valid": true,
    "account_id": "65a...",
    "app_specific_role": "premium_user",
    "telegram_id": "123456"
}</code></pre>
            </section>

            <section id="internal-linking" class="mb-16">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Account Linking (Web ‚Üî Telegram)</h3>
                <p class="mb-4">To link a web session to a Telegram user, generate a <code>link_token</code> and pass it to your bot.</p>

                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-slate-900">Step 1: Generate Token (Web Backend)</h4>
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                            <code class="text-slate-600 text-sm">/internal/generate-link-token</code>
                        </div>
                        <pre><code class="language-json">{ "account_id": "CURRENT_USER_ID" }</code></pre>
                        <p class="text-sm">Returns: <code>{ "token": "xyz_secure_token" }</code></p>
                    </div>

                    <div>
                        <h4 class="font-bold text-slate-900">Step 2: Link (Bot Backend)</h4>
                        <p class="text-sm mb-2">When user sends <code>/start xyz_secure_token</code> to your bot:</p>
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                            <code class="text-slate-600 text-sm">/internal/link-account</code>
                        </div>
                        <pre><code class="language-json">{
    "link_token": "xyz_secure_token",
    "telegram_id": "123456789"
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="internal-user" class="mb-16">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Get User Info</h3>
                <div class="flex items-center space-x-2 mb-2">
                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold uppercase">GET</span>
                    <code class="text-slate-600 text-sm">/internal/users/{user_id}</code>
                </div>
                <p class="text-sm">Retrieve public profile data (Display Name, Username, Email mask) for a global user ID.</p>
            </section>

            <hr class="border-slate-200 my-10">

            <section id="payments-intent" class="mb-16">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">3. Payments</h2>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Secure Intent (Enterprise Flow)</h3>
                <p class="mb-4">Create a server-side transaction record before showing payment options to the user.</p>

                <div class="flex items-center space-x-2 mb-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                    <code class="text-slate-600 text-sm">/internal/payments/secure-intent</code>
                </div>
                <pre><code class="language-json">{
    "account_id": "OPTIONAL_USER_ID",
    "amount": 9.99,
    "currency": "USD",
    "target_role": "premium_user",
    "duration": "1m", // 1m, 3m, 6m, 1y, lifetime
    "client_ref_id": "INV-2024-001"
}</code></pre>
                <h4 class="font-bold text-slate-800 mb-2">Response</h4>
                <pre><code class="language-json">{
    "success": true,
    "transaction_id": "tx-a1b2c3d4",
    "secure_link": "https://t.me/bifrost_byhelm_bot?start=tx-a1b2c3d4",
    "manual_command": "/pay tx-a1b2c3d4"
}</code></pre>
            </section>

            <section id="payments-proof" class="mb-16">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Submit Payment Proof</h3>
                <p class="mb-4">Allows a user to upload a screenshot of their bank transfer via your Web App. This forwards the image to the Telegram Admin Group for manual approval.</p>

                <div class="flex items-center space-x-2 mb-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">POST</span>
                    <code class="text-slate-600 text-sm">/internal/payments/submit-proof</code>
                </div>
                <p class="text-sm font-bold mb-2">Content-Type: <code>multipart/form-data</code></p>
                <ul class="list-disc pl-5 mb-4 text-sm">
                    <li><code>file</code>: The image file.</li>
                    <li><code>account_id</code>: The Bifrost User ID.</li>
                    <li><code>transaction_id</code>: (Optional) The pending TX ID.</li>
                </ul>
            </section>

            <hr class="border-slate-200 my-10">

            <section id="webhooks-security" class="mb-16">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">4. Webhooks</h2>
                <p class="mb-4">Bifrost sends events to your configured <code>API URL</code>. You must verify the signature.</p>

                <h3 class="text-lg font-bold text-slate-800 mb-2">Signature Verification (Python Example)</h3>
                <p class="text-sm mb-2">Headers contain <code>X-Bifrost-Signature</code> (HMAC-SHA256 hex digest).</p>

                <pre><code class="language-python">import hmac
import hashlib
import json

def verify_bifrost_webhook(request, secret):
    signature = request.headers.get('X-Bifrost-Signature')
    # Bifrost uses compact JSON (separators=(',', ':'))
    payload_bytes = request.get_data()

    expected = hmac.new(
        key=secret.encode('utf-8'),
        msg=payload_bytes,
        digestmod=hashlib.sha256
    ).hexdigest()

    return hmac.compare_digest(expected, signature)</code></pre>
            </section>

            <section id="webhooks-types" class="mb-16">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Event Payloads</h3>

                <div class="space-y-6">
                    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <code class="text-indigo-600 font-bold">subscription_success</code>
                            <span class="text-xs font-bold bg-green-100 text-green-800 px-2 py-1 rounded">Payment</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Fired after successful payment or admin approval.</p>
                        <pre class="mb-0"><code class="language-json">{
    "event": "subscription_success",
    "account_id": "65a...",
    "timestamp": 1705881234,
    "transaction_id": "tx-123",
    "amount": 9.99,
    "role": "premium_user",
    "duration": "1m",
    "expires_at": "2026-02-28T12:00:00+00:00",
    "client_ref_id": "INV-001"
}</code></pre>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <code class="text-red-600 font-bold">subscription_expired</code>
                            <span class="text-xs font-bold bg-slate-100 text-slate-800 px-2 py-1 rounded">Scheduler</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Fired when the subscription reaper downgrades a user.</p>
                        <pre class="mb-0"><code class="language-json">{
    "event": "subscription_expired",
    "account_id": "65a...",
    "timestamp": 1705881234,
    "previous_role": "premium_user",
    "new_role": "user",
    "reason": "expired"
}</code></pre>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <code class="text-amber-600 font-bold">account_update</code>
                            <span class="text-xs font-bold bg-slate-100 text-slate-800 px-2 py-1 rounded">Identity</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-3">Fired when a user links a new credential (e.g., links Telegram).</p>
                        <pre class="mb-0"><code class="language-json">{
    "event": "account_update",
    "account_id": "65a...",
    "telegram_id": "123456789",
    "email": "updated@example.com"
}</code></pre>
                    </div>
                </div>
            </section>

        </div>
    </main>
</div>

</body>
</html>