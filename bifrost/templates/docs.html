<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bifrost API Reference</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        code { font-family: 'JetBrains Mono', monospace; }
        html { scroll-behavior: smooth; }

        /* Copy Animation Classes - Tooltip Style */
        .endpoint-copy {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .endpoint-copy:hover {
            background-color: #e2e8f0; /* slate-200 */
        }
        .endpoint-copy:active {
            transform: scale(0.98);
        }
        /* Tooltip positioned above to avoid overlap */
        .endpoint-copy::after {
            content: 'Click to copy';
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 5px;
            background-color: #1e293b; /* slate-800 */
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 10;
        }
        .endpoint-copy:hover::after {
            opacity: 1;
        }

        /* Payload Highlighter */
        .payload-block {
            border-left: 4px solid #6366f1; /* Indigo-500 */
        }
    </style>
</head>
<body class="bg-base-100">

<div id="toast-container" class="toast toast-end z-50"></div>

<div class="drawer lg:drawer-open">
  <input id="docs-drawer" type="checkbox" class="drawer-toggle" />

  <div class="drawer-content flex flex-col">
    <div class="w-full navbar bg-base-100 lg:hidden border-b border-base-200 sticky top-0 z-30">
      <div class="flex-none">
        <label for="docs-drawer" class="btn btn-square btn-ghost">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </label>
      </div>
      <div class="flex-1 px-2 mx-2 font-bold text-lg">Bifrost API</div>
    </div>

    <main class="p-6 lg:p-12 max-w-6xl mx-auto w-full">

        <!-- UPDATED: Added docs version note -->
        <div class="alert alert-info mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>Documentation updated to v0.6.0 (2026-01-29). See <a href="{{ url_for('changelog_page') }}" class="link">Changelog</a> for details.</span>
        </div>

        <section id="introduction" class="mb-16 scroll-mt-24">
            <h1 class="text-4xl font-extrabold text-base-content mb-4">Introduction</h1>
            <p class="text-lg text-base-content/70 leading-relaxed mb-6">
                <strong>Bifrost</strong> is the centralized Identity Provider (IdP) and Payment Gateway for the Helm Ecosystem.
                It acts as the secure bridge between users, client applications, and financial providers.
            </p>
            <p class="text-base-content/70 leading-relaxed mb-8">
                By integrating with Bifrost, your application gains:
                <br>â€¢ <strong>Unified Login:</strong> Single Sign-On (SSO) via Email or Telegram.
                <br>â€¢ <strong>Role Management:</strong> Centralized permission handling (Guest, User, Premium, Admin).
                <br>â€¢ <strong>Payment Processing:</strong> Abstraction layer for ABA PayWay, Gumroad, and Manual/Bot payments.
                <!-- UPDATED: Added branding mention -->
                <br>â€¢ <strong>Branding Support:</strong> Custom logos, QR codes, and email templates per app.
            </p>

            <div class="flex gap-4 items-center bg-base-200 p-4 rounded-xl border border-base-300">
                <div class="badge badge-primary badge-lg gap-2">Base URL</div>
                <code onclick="copyText('https://objective-denna-auppecampus-9a7d86fc.koyeb.app')" class="endpoint-copy font-mono text-sm font-bold flex-1 truncate">https://objective-denna-auppecampus-9a7d86fc.koyeb.app</code>
            </div>
        </section>

        <div class="divider"></div>

        <section id="roles-hierarchy" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
                <span class="bg-neutral text-neutral-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">0</span>
                Role Hierarchy
            </h2>

            <div class="grid lg:grid-cols-2 gap-12">
                <div>
                    <p class="mb-6 text-base-content/80">
                        Bifrost maintains a clear hierarchy of roles, where each level builds on the access and capabilities of the ones below it. This structure ensures secure and scalable user management across applications.
                        <br><span class="text-xs text-warning">Note: Verified users (non-guest) cannot be removed by admins to protect data ownership and integrity.</span>
                        <br><span class="text-xs text-info">Client apps have full flexibility to define and name their subscription tiers (e.g., 'basic', 'pro', 'elite', 'gold', 'platinum'). Bifrost records these roles without any restrictions or predefined limitsâ€”apps can create as many tiers as needed, such as one 'basic' plan, two 'gold' variations, or three 'platinum' levels. Bifrost handles them uniformly for authentication, leaving the interpretation and feature gating entirely to the client app.</span>
                    </p>
                    <ul class="steps steps-vertical w-full">
                        <li class="step step-neutral" data-content="?">
                            <div class="text-left w-full pl-4">
                                <strong class="block">Guest</strong>
                                <span class="text-xs text-base-content/60">Represents unauthenticated users or those with unverified emails, providing minimal access.</span>
                            </div>
                        </li>
                        <li class="step step-primary" data-content="âœ“">
                            <div class="text-left w-full pl-4">
                                <strong class="block">User</strong>
                                <span class="text-xs text-base-content/60">The base level for authenticated users on a free tier, with standard access to core features.</span>
                            </div>
                        </li>
                        <li class="step step-accent" data-content="â˜…">
                            <div class="text-left w-full pl-4">
                                <strong class="block">Subscriber</strong>
                                <span class="text-xs text-base-content/60">Users with an active subscription, unlocking enhanced features. Custom tiers (e.g., 'basic', 'gold', 'platinum') are treated the same way by Bifrost.</span>
                            </div>
                        </li>
                        <li class="step step-secondary" data-content="ðŸ›¡ï¸">
                            <div class="text-left w-full pl-4">
                                <strong class="block">Admin</strong>
                                <span class="text-xs text-base-content/60">Application-specific administrators who can manage users, approve payments, and handle app-level configurations.</span>
                            </div>
                        </li>
                        <!-- UPDATED: Clarified super_admin -->
                        <li class="step step-secondary" data-content="âš¡">
                            <div class="text-left w-full pl-4">
                                <strong class="block">Super Admin</strong>
                                <span class="text-xs text-base-content/60">Global overseers with access to manage multiple apps, users, and system-wide settings.</span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="bg-base-200 p-6 rounded-xl border border-base-300 h-fit">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="badge badge-warning">System Level</span>
                        <h3 class="font-bold">God Admin (Bifrost Admin)</h3>
                    </div>
                    <p class="text-sm mb-4">
                        This elevated role operates beyond individual client apps, providing ecosystem-wide oversight for tasks like debugging, billing oversight, and infrastructure management.
                    </p>
                    <div class="alert bg-base-100 shadow-sm text-xs">
                        This role cannot be assigned through the API and is reserved exclusively for Bifrost system maintainers.
                    </div>
                </div>
            </div>
        </section>

        <!-- UPDATED: New section for Flows & Guides -->
        <section id="flows-guides" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">1</span>
                Flows & Guides
            </h2>
            <p class="mb-6 text-base-content/70">These step-by-step guides walk you through key integration processes, from user registration to secure payments. Each flow includes endpoint details, payloads, and tips for smooth implementation.</p>

            <div class="space-y-8">
                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Registration Flow (Email OTP)</h3>
                        <p class="text-sm mb-4 text-base-content/70">This flow handles new user sign-ups using email verification, ensuring secure account creation and automatic app linking.</p>
                        <ol class="steps steps-vertical">
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Check if Exists:</strong> POST /auth/api/check-email
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{ "email": "user@example.com" }</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Determines if the email is already registered to guide the UI (login vs. register).</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Request OTP:</strong> POST /auth/api/request-email-otp
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{ "email": "user@example.com", "client_id": "your_client_id" }</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Generates a 6-digit code and sends a branded email (with app name and logo) to the user.</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Verify OTP:</strong> POST /auth/api/verify-email-otp
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{ "verification_id": "returned_from_request", "code": "123456" }</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Validates the code and returns a short-lived proof_token for setting credentials.</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Complete Registration:</strong> POST /auth/api/complete-registration
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{
  "proof_token": "from_verify_step",
  "password": "user_password",
  "display_name": "User Name",
  "username": "unique_username",
  "client_id": "your_client_id"
}</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Finalizes the account, links it to your app, and issues a JWT for immediate use.</span>
                                </div>
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Account Linking (Web to Telegram)</h3>
                        <p class="text-sm mb-4 text-base-content/70">Seamlessly merge web-based accounts with Telegram identities for a unified user experience across platforms.</p>
                        <ol class="steps steps-vertical">
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Generate Link Token:</strong> POST /internal/generate-link-token
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{ "account_id": "bifrost_account_id" }</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Creates a secure deep_link_token to initiate the Bot connection.</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>User Clicks Deep Link:</strong> t.me/BifrostBot?start=link_{deep_link_token}
                                    <span class="text-xs text-base-content/60">Directs the user to the Bifrost Bot for Telegram authentication.</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Link Account:</strong> POST /internal/link-account
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{ "link_token": "from_generate_step", "telegram_id": "user_telegram_id" }</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Completes the merge of identities and triggers an account_update webhook to notify your app.</span>
                                </div>
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Payment Proof Submission</h3>
                        <p class="text-sm mb-4 text-base-content/70">Allows users to upload payment evidence (e.g., screenshots) from web interfaces, with admin review for verification.</p>
                        <ol class="steps steps-vertical">
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Create Intent (Optional):</strong> POST /internal/payments/secure-intent
                                    <div class="payload-block pl-4 mt-2">
                                        <pre><code class="language-json">{ "amount": 9.99, "currency": "USD", "target_role": "premium", "duration": "1m", "client_ref_id": "INV-001" }</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Pre-registers payment details to prevent tampering.</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Submit Proof:</strong> POST /internal/payments/submit-proof (multipart/form-data)
                                    <div class="mockup-code bg-[#282c34] text-xs mt-2">
                                        <pre data-prefix=">"><code>file: (binary_image_data)</code></pre>
                                        <pre data-prefix=">"><code>account_id: "bifrost_account_id"</code></pre>
                                        <pre data-prefix=">"><code>transaction_id: "tx-..." (optional)</code></pre>
                                    </div>
                                    <span class="text-xs text-base-content/60">Uploads the proof and forwards it to the admin group for review.</span>
                                </div>
                            </li>
                            <li class="step step-primary">
                                <div class="pl-4">
                                    <strong>Poll Status:</strong> GET /internal/payments/status/{transaction_id}
                                    <span class="text-xs text-base-content/60">Checks approval status in real-time, or await the subscription_success webhook for confirmation.</span>
                                </div>
                            </li>
                        </ol>
                    </div>
                </div>

                <!-- UPDATED: Added HMAC example -->
                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">HMAC Webhook Verification (Python Example)</h3>
                        <p class="text-sm mb-4 text-base-content/70">Webhooks from Bifrost include an HMAC signature in the X-Bifrost-Signature header for security. This signature is generated using your client secret and the request body, allowing you to verify that the payload originated from Bifrost and hasn't been tampered with. Use this code snippet to validate incoming webhooks before processing them.</p>
                        <pre><code class="language-python">import hmac
import hashlib

def verify_webhook(request_body, signature_header, client_secret):
    computed_sig = hmac.new(
        client_secret.encode(),
        request_body.encode(),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(computed_sig, signature_header)</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <section id="auth-hosted" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">2</span> <!-- UPDATED: Renumbered -->
                Hosted Login UI
            </h2>
            <p class="mb-6 text-base-content/70">These URLs should be opened in the user's browser to initiate authentication flows. Supports custom branding (app logo in emails).</p> <!-- UPDATED: Added branding note -->

            <div class="overflow-x-auto bg-base-100 border border-base-200 rounded-xl shadow-sm">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr class="bg-base-200 text-base-content">
                            <th class="w-1/4">View Name</th>
                            <th class="w-1/3">Endpoint URL (Click to Copy)</th>
                            <th>Description & Parameters</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-bold">Sign In</td>
                            <td><code onclick="copyText('/auth/ui/login')" class="endpoint-copy text-xs bg-base-300 p-2 rounded block">/auth/ui/login</code></td>
                            <td class="text-sm">
                                Standard Login.<br>
                                <span class="badge badge-xs badge-outline mt-1">Param</span> <code>client_id</code>
                            </td>
                        </tr>
                        <tr>
                            <td class="font-bold">Forgot Password</td>
                            <td><code onclick="copyText('/auth/ui/forgot-password')" class="endpoint-copy text-xs bg-base-300 p-2 rounded block">/auth/ui/forgot-password</code></td>
                            <td class="text-sm">
                                Self-service recovery.<br>
                                <span class="badge badge-xs badge-outline mt-1">Param</span> <code>client_id</code>
                            </td>
                        </tr>
                        <tr>
                            <td class="font-bold">Activate Account</td>
                            <td><code onclick="copyText('/auth/ui/set-password')" class="endpoint-copy text-xs bg-base-300 p-2 rounded block">/auth/ui/set-password</code></td>
                            <td class="text-sm">
                                Invite Flow (from Email).<br>
                                <span class="badge badge-xs badge-outline mt-1">Param</span> <code>verification_id</code>, <code>client_id</code>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="auth-api" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">3</span> <!-- UPDATED: Renumbered -->
                Client API (Public Authentication)
            </h2>
            <p class="mb-6 text-base-content/80">Public endpoints for custom frontends (Headless Mode). No Basic Auth required. <!-- UPDATED: Added OTP note --> Supports OTP race condition fixes and whitespace cleaning.</p>

            <div class="space-y-4">
                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-info text-xs">GET</span>
                        <code onclick="copyText('/health')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/health</code>
                    </div>
                    <div class="collapse-content">
                         <p class="text-sm py-2">Checks service availability.</p>
                         <pre><code class="language-json">{ "status": "ok", "message": "Bifrost IdP operational." }</code></pre>
                    </div>
                </div>

                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/check-email')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/check-email</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{ "email": "user@example.com" } // OR { "username": "..." }</code></pre> <!-- UPDATED: Added username option -->
                        </div>
                    </div>
                </div>

                <!-- UPDATED: Added missing endpoints -->
                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/request-email-otp')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/request-email-otp</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{ "email": "user@example.com", "client_id": "..." }</code></pre>
                        </div>
                        <p class="text-sm mt-2">Generates and emails OTP (branded with app name/logo).</p>
                    </div>
                </div>

                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/verify-email-otp')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/verify-email-otp</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{ "verification_id": "...", "code": "123456" }</code></pre>
                        </div>
                        <p class="text-sm mt-2">Returns proof_token for registration/reset.</p>
                    </div>
                </div>

                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/complete-registration')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/complete-registration</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "proof_token": "...",
    "password": "...",
    "display_name": "...",
    "username": "...",
    "client_id": "..."
}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/reset-password')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/reset-password</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{ "proof_token": "...", "password": "..." }</code></pre>
                        </div>
                    </div>
                </div>

                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" checked />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/login')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/login</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "client_id": "YOUR_CLIENT_ID",
    "identifier": "user@example.com", // OR username
    "password": "secret_password"
}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/verify-otp-login')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/verify-otp-login</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "client_id": "YOUR_CLIENT_ID",
    "code": "123456"
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- UPDATED: Added Telegram login -->
                <div class="collapse collapse-arrow border border-base-200 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium flex gap-3 items-center">
                        <span class="badge badge-success text-xs">POST</span>
                        <code onclick="copyText('/auth/api/telegram-login')" class="endpoint-copy hover:bg-base-200 px-2 rounded">/auth/api/telegram-login</code>
                    </div>
                    <div class="collapse-content">
                         <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "client_id": "YOUR_CLIENT_ID",
    "telegram_data": { ... } // From Telegram Widget
}</code></pre>
                        </div>
                        <p class="text-sm mt-2">Verifies Telegram data using app's bot_token.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="internal-api" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">4</span> <!-- UPDATED: Renumbered -->
                Internal API (Server-to-Server)
            </h2>
            <div class="alert alert-warning shadow-sm mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333 .192 3 1.732 3z" /></svg>
                <div class="text-xs">
                    <strong>Auth Required:</strong> <code>Username = Client ID</code>, <code>Password = Client Secret</code>.
                    <!-- UPDATED: Added security note -->
                    <br><span class="text-warning">Security: Cannot promote to admin/super_admin via payments (FORBIDDEN_ROLES).</span>
                </div>
            </div>

            <div class="overflow-x-auto bg-base-100 border border-base-200 rounded-xl">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Endpoint (Click to Copy)</th>
                            <th>Method</th>
                            <th>Payload Example</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code onclick="copyText('/internal/validate-token')" class="endpoint-copy text-xs bg-base-300 p-2 rounded">/internal/validate-token</code></td>
                            <td><span class="badge badge-success badge-xs">POST</span></td>
                            <td><code class="text-xs">{ "jwt": "..." }</code> <!-- UPDATED: Note --> <br><span class="text-xs text-base-content/60">Returns telegram_id if present.</span></td>
                        </tr>
                        <tr>
                            <td><code onclick="copyText('/internal/users/<user_id>')" class="endpoint-copy text-xs bg-base-300 p-2 rounded">/internal/users/&lt;user_id&gt;</code></td>
                            <td><span class="badge badge-info badge-xs">GET</span></td>
                            <td><span class="text-xs text-base-content/50">Fetch basic user profile</span></td>
                        </tr>
                        <tr>
                            <td><code onclick="copyText('/internal/generate-link-token')" class="endpoint-copy text-xs bg-base-300 p-2 rounded">/internal/generate-link-token</code></td>
                            <td><span class="badge badge-success badge-xs">POST</span></td>
                            <td><code class="text-xs">{ "account_id": "..." }</code></td>
                        </tr>
                        <tr>
                            <td><code onclick="copyText('/internal/link-account')" class="endpoint-copy text-xs bg-base-300 p-2 rounded">/internal/link-account</code></td>
                            <td><span class="badge badge-success badge-xs">POST</span></td>
                            <td><code class="text-xs">{ "link_token": "...", "telegram_id": "..." }</code></td>
                        </tr>
                        <tr>
                            <td><code onclick="copyText('/internal/generate-otp')" class="endpoint-copy text-xs bg-base-300 p-2 rounded">/internal/generate-otp</code></td>
                            <td><span class="badge badge-success badge-xs">POST</span></td>
                            <td><code class="text-xs">{ "telegram_id": "123456" }</code></td>
                        </tr>
                        <tr>
                            <td><code onclick="copyText('/internal/get-role')" class="endpoint-copy text-xs bg-base-300 p-2 rounded">/internal/get-role</code></td>
                            <td><span class="badge badge-success badge-xs">POST</span></td>
                            <td><code class="text-xs">{ "telegram_id": "123456" }</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="payments-api" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">5</span> <!-- UPDATED: Renumbered -->
                Payments API
            </h2>
            <!-- UPDATED: Added custom QR note -->
            <p class="mb-6 text-base-content/70">Supports tamper-proof intents. Apps can set custom QR codes (app_qr_url) via Backoffice for Bot payments.</p>

            <div class="space-y-8">

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <div class="flex justify-between items-start">
                            <h3 class="card-title text-base">Secure Payment Intent</h3>
                            <div class="badge badge-success">POST</div>
                        </div>
                        <code onclick="copyText('/internal/payments/secure-intent')" class="endpoint-copy text-sm bg-base-200 p-2 rounded block mb-2 mt-2">/internal/payments/secure-intent</code>

                        <div class="payload-block pl-4 mt-2">
                             <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "amount": 9.99,
    "currency": "USD",
    "target_role": "premium_user",
    "duration": "1m", // 1m, 3m, 6m, 1y, lifetime
    "client_ref_id": "INV-1001"
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- UPDATED: Added polling from [0.6.0] -->
                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <div class="flex justify-between items-start">
                            <h3 class="card-title text-base">Check Payment Status (Polling)</h3>
                            <div class="badge badge-info">GET</div>
                        </div>
                        <p class="text-sm text-base-content/70">Check if a transaction has been completed (real-time alternative to webhooks).</p>
                        <code onclick="copyText('/internal/payments/status/<transaction_id>')" class="endpoint-copy text-sm bg-base-200 p-2 rounded block mb-2 mt-2">/internal/payments/status/&lt;transaction_id&gt;</code>

                        <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Response</div>
                            <pre><code class="language-json">{
    "transaction_id": "tx-123...",
    "status": "completed", // or 'pending'
    "amount": 9.99
}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <div class="flex justify-between items-start">
                            <h3 class="card-title text-base">Universal Claim</h3>
                            <div class="badge badge-success">POST</div>
                        </div>
                        <p class="text-sm text-base-content/70">Manually claim a transaction (found via bank logs, etc.) for a specific user.</p>
                        <code onclick="copyText('/internal/payments/claim')" class="endpoint-copy text-sm bg-base-200 p-2 rounded block mb-2 mt-2">/internal/payments/claim</code>

                        <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "trx_input": "ABA_123456789", // The raw transaction ID to find
    "target_app_id": "your_client_id_here",
    "identity_type": "telegram_id", // Options: 'telegram_id', 'account_id', 'email'
    "identity_value": "9988776655"
}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <div class="flex justify-between items-start">
                            <h3 class="card-title text-base">Admin Grant (Manual Upgrade)</h3>
                            <div class="badge badge-success">POST</div>
                        </div>
                        <p class="text-sm text-base-content/70">Forcefully upgrade a user's role without payment. Defaults to 1 month if no duration.</p> <!-- UPDATED: Added default note -->
                        <code onclick="copyText('/internal/grant-role')" class="endpoint-copy text-sm bg-base-200 p-2 rounded block mb-2 mt-2">/internal/grant-role</code>

                        <div class="payload-block pl-4 mt-2">
                            <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Payload</div>
                            <pre><code class="language-json">{
    "telegram_id": "123456789",
    "target_client_id": "optional_if_cross_app",
    "target_role": "premium_user",
    "duration": "1m" // optional
}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <div class="flex justify-between items-start">
                            <h3 class="card-title text-base">Submit Proof (Web Upload)</h3>
                            <div class="badge badge-success">POST</div>
                        </div>
                        <code onclick="copyText('/internal/payments/submit-proof')" class="endpoint-copy text-sm bg-base-200 p-2 rounded block mb-2 mt-2">/internal/payments/submit-proof</code>
                        <div class="text-xs font-bold uppercase tracking-wide text-base-content/50 mb-1">Multipart Form Data</div>
                        <div class="mockup-code bg-[#282c34] text-xs">
                            <pre data-prefix=">"><code>file: (binary_image_data)</code></pre>
                            <pre data-prefix=">"><code>account_id: "65a..."</code></pre>
                            <pre data-prefix=">"><code>transaction_id: "tx-..." (optional)</code></pre>
                        </div>
                        <!-- UPDATED: Added note -->
                        <p class="text-sm mt-2">Forwards proof to Telegram admin group for approval (supports app admins).</p>
                    </div>
                </div>

            </div>
        </section>

        <section id="webhooks" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">6</span> <!-- UPDATED: Renumbered -->
                Webhooks
            </h2>
            <p class="text-sm mb-4 text-base-content/70">Bifrost sends real-time notifications to your configured webhook URL for key events. Each webhook includes an HMAC signature (see the verification example in Flows & Guides) to ensure authenticity and integrity.</p>
            <div class="mockup-code bg-[#282c34] text-white mb-8">
                <pre><code>Header: X-Bifrost-Signature</code></pre>
                <pre><code>Value: HMAC-SHA256(Client_Secret, Request_Body)</code></pre>
            </div>

            <div class="collapse collapse-plus bg-base-100 border border-base-200">
                <input type="radio" name="webhook-accordion" checked="checked" />
                <div class="collapse-title text-md font-bold text-indigo-600">subscription_success</div>
                <div class="collapse-content">
                    <pre><code class="language-json">{
  "event": "subscription_success",
  "account_id": "65a...",
  "amount": 9.99,
  "role": "premium_user",
  "duration": "1m", // UPDATED: Added from [0.3.3]
  "expires_at": "2026-03-01T12:00:00Z" // UPDATED: Added from [0.3.3]
}</code></pre>
                    <p class="text-sm mt-2">Sent when a payment is approved, including details like the new role and expiration.</p>
                </div>
            </div>

            <div class="collapse collapse-plus bg-base-100 border border-base-200 mt-2">
                <input type="radio" name="webhook-accordion" />
                <div class="collapse-title text-md font-bold text-rose-600">subscription_expired</div>
                <div class="collapse-content">
                    <pre><code class="language-json">{
  "event": "subscription_expired",
  "account_id": "65a...",
  "new_role": "user"
}</code></pre>
                    <!-- UPDATED: Added reaper note -->
                    <p class="text-sm mt-2">Triggered by the hourly reaper when a subscription lapses, downgrading the user.</p>
                </div>
            </div>

            <!-- UPDATED: Added more events -->
            <div class="collapse collapse-plus bg-base-100 border border-base-200 mt-2">
                <input type="radio" name="webhook-accordion" />
                <div class="collapse-title text-md font-bold text-green-600">account_update</div>
                <div class="collapse-content">
                    <pre><code class="language-json">{
  "event": "account_update",
  "account_id": "65a...",
  "extra_data": {
    "telegram_id": "123456", // UPDATED: From [0.2.1]
    "email": "user@example.com",
    "username": "user123"
  }
}</code></pre>
                    <p class="text-sm mt-2">Notifies of changes to user identity fields, such as adding a Telegram ID.</p>
                </div>
            </div>

            <div class="collapse collapse-plus bg-base-100 border border-base-200 mt-2">
                <input type="radio" name="webhook-accordion" />
                <div class="collapse-title text-md font-bold text-purple-600">account_role_change</div>
                <div class="collapse-content">
                    <pre><code class="language-json">{
  "event": "account_role_change",
  "account_id": "65a...",
  "new_role": "premium_user"
}</code></pre>
                    <p class="text-sm mt-2">Generic notification for any role updates, such as manual grants by admins.</p>
                </div>
            </div>
        </section>

        <!-- UPDATED: New section for Advanced Features -->
        <section id="advanced" class="mb-24 scroll-mt-24">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="bg-primary text-primary-content w-8 h-8 rounded-lg flex items-center justify-center text-sm">7</span>
                Advanced Features
            </h2>
            <p class="text-sm mb-6 text-base-content/70">Bifrost includes powerful tools and integrations to enhance security, branding, and user management. Below, we dive into each feature with practical details and examples.</p>
            <div class="space-y-8">
                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Bifrost Bot</h3>
                        <p class="text-sm text-base-content/70">The Bifrost Bot is a dedicated Telegram bot serving as a central hub for authentication and payments. It supports deep links for seamless account linking (e.g., <code>t.me/BifrostBot?start=link_{token}</code>) and the /pay command, which displays app-branded instructions and custom QR codes. Admins receive approval requests directly in chat, with inline buttons for quick actions.</p>
                        <div class="mockup-phone mt-4">
                            <div class="camera"></div>
                            <div class="display">
                                <div class="artboard artboard-demo phone-1 p-4">
                                    <div class="chat chat-start">
                                        <div class="chat-bubble">/pay your_app_id</div>
                                    </div>
                                    <div class="chat chat-end">
                                        <div class="chat-bubble">Scan this QR to pay $9.99 for Premium (Your App Name)<br><img src="https://example.com/custom-qr.png" alt="Custom QR" class="w-32 h-32 mx-auto mt-2"></div>
                                    </div>
                                    <div class="chat chat-start">
                                        <div class="chat-bubble">Upload proof screenshot.</div>
                                    </div>
                                    <div class="chat chat-end">
                                        <div class="chat-bubble">Approved! Enjoy your subscription.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs mt-4 text-base-content/60">Example chat flow: Users interact via commands, and the bot handles tamper-proof transactions using IDs.</p>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Custom QR Branding</h3>
                        <p class="text-sm text-base-content/70">Personalize the payment experience by uploading your own QR code (e.g., for ABA or ACLEDA) in the Backoffice under app settings. When users trigger /pay in the Bifrost Bot, they'll see your custom QR instead of the default, creating a fully white-labeled flow that aligns with your brand.</p>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Enhanced Permissions</h3>
                        <p class="text-sm text-base-content/70">App-specific admins gain targeted control: they can review and approve payment proofs only for their own application via the Bifrost Bot. This decentralized approach, combined with global super admin oversight, ensures efficient management without bottlenecks.</p>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Passkeys (Future)</h3>
                        <p class="text-sm text-base-content/70">Bifrost is prepared for passwordless authentication with built-in support for WebAuthn credentials in the database models. This feature will enable seamless, secure logins using biometrics or hardware keys once fully implemented.</p>
                    </div>
                </div>

                <div class="card bg-base-100 border border-base-200">
                    <div class="card-body p-6">
                        <h3 class="card-title text-base">Smart Invites</h3>
                        <p class="text-sm text-base-content/70">Streamline onboarding with automated, branded email invitations from the Backoffice. When adding new users or admins, Bifrost generates a unique activation link embedded in the emailâ€”users can set their password directly without an OTP, simplifying the process while maintaining security.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>
  </div>

  <div class="drawer-side z-40">
    <label for="docs-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
    <aside class="bg-base-200 w-80 min-h-full flex flex-col border-r border-base-300">

        <div class="p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Bifrost" class="h-8 w-auto">
                <span class="font-bold text-xl tracking-tight">Bifrost API</span>
            </div>
            <div class="badge badge-success badge-outline mt-3 font-bold gap-2 w-full py-3">
                <div class="w-2 h-2 rounded-full bg-success animate-pulse"></div>
                System Operational
            </div>
        </div>

        <ul class="menu p-4 w-full text-base-content font-medium gap-1">
            <li class="menu-title opacity-50 uppercase tracking-widest text-xs mt-2">Getting Started</li>
            <li><a href="#introduction" class="nav-link">Introduction</a></li>
            <li><a href="#roles-hierarchy" class="nav-link">Role Hierarchy</a></li>

            <!-- UPDATED: Added new sidebar items -->
            <li class="menu-title opacity-50 uppercase tracking-widest text-xs mt-6">Guides</li>
            <li><a href="#flows-guides" class="nav-link">Flows & Guides</a></li>

            <li class="menu-title opacity-50 uppercase tracking-widest text-xs mt-6">Authentication</li>
            <li><a href="#auth-hosted" class="nav-link">Hosted UI</a></li>
            <li><a href="#auth-api" class="nav-link">Client API</a></li>

            <li class="menu-title opacity-50 uppercase tracking-widest text-xs mt-6">Backend Integration</li>
            <li><a href="#internal-api" class="nav-link">Internal API (S2S)</a></li>
            <li><a href="#payments-api" class="nav-link">Payments</a></li>
            <li><a href="#webhooks" class="nav-link">Webhooks</a></li>
            <li><a href="#advanced" class="nav-link">Advanced Features</a></li> <!-- UPDATED: Added -->

            <li class="mt-8">
                <a href="{{ url_for('changelog_page') }}" class="btn btn-warning btn-sm text-warning-content no-animation justify-start">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                    System Changelog
                </a>
            </li>
        </ul>

        <div class="mt-auto p-4 border-t border-base-300">
            <a href="/backoffice" class="btn btn-neutral w-full">â† Back to Portal</a>
        </div>
    </aside>
  </div>
</div>

<script>
    function copyText(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.createElement('div');
            toast.className = 'alert alert-success text-white text-xs py-2 px-4 shadow-lg rounded-xl';
            toast.innerText = 'Copied to clipboard!';

            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.nav-link');

        // Scroll Spy
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    navLinks.forEach(link => link.classList.remove('active'));
                    const id = entry.target.getAttribute('id');
                    const activeLink = document.querySelector(`.nav-link[href="#${id}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
            });
        }, { rootMargin: '-20% 0px -60% 0px' });

        sections.forEach(section => observer.observe(section));
    });
</script>
</body>
</html>